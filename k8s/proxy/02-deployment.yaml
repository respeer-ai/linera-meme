apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: proxy-service
  namespace: kube-system
spec:
  serviceName: proxy-service
  replicas: ${REPLICAS}
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: proxy-service
  template:
    metadata:
      labels:
        app: proxy-service
    spec:
      # topologySpreadConstraints:
      # - maxSkew: 1
      #   topologyKey: kubernetes.io/hostname
      #   whenUnsatisfiable: ScheduleAnyway
      #   labelSelector:
      #     matchLabels:
      #       app: proxy-service
      initContainers:
      - name: init-wallet
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          POD_INDEX=$(hostname | awk -F '-' '{print $NF}')
          if [ -f /shared-app-data/PROXY_WALLET_OWNER.$POD_INDEX ]; then
            OWNER=$(cat /shared-app-data/PROXY_WALLET_OWNER.$POD_INDEX)
          fi
          if [ ! -f /wallet/wallet.json -o ! -f /wallet/keystore.json -o ! -f /shared-app-data/PROXY_WALLET_OWNER.$POD_INDEX -o -z "$OWNER" ]; then
            echo "No wallet found in pod $POD_INDEX, creating..."
            now=$(date -u | sed 's/ //g')
            mkdir -p /wallet/backup/$now
            mv /wallet/wallet.json /wallet/keystore.json /wallet/backup/$now || true
            rm -rf /wallet/client.db
            rm -rf /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID
            rm -rf /shared-app-data/PROXY_APPLICATION_ID
            ./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db wallet init --faucet ${FAUCET_URL}
            OWNER=$(./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db keygen)
            echo $OWNER > /shared-app-data/PROXY_WALLET_OWNER.$POD_INDEX
          else
            echo "Wallet already exists, skipping init."
          fi
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
      - name: request-chain
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          POD_INDEX=$(hostname | awk -F '-' '{print $NF}')
          if [ $POD_INDEX -eq 0 ]; then
            CHAINS=$(./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db wallet show | awk 'BEGIN{count=0} /^Default owner:/ { if ($3 != "No") count++ } END { print count }')
            if [ -z "$CHAINS" -o $CHAINS -eq 0 -o ! -f /shared-app-data/PROXY_CREATOR_WALLET_CHAIN_ID ]; then
              echo "No chain found in creator wallet, requesting ..."
              CHAIN_ID=$(./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db wallet request-chain --faucet ${FAUCET_URL} | head -n 1)
              CHAINS=$(./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db wallet show | awk 'BEGIN{count=0} /^Default owner:/ { if ($3 != "No") count++ } END { print count }')
              if [ -z "$CHAINS" -o $CHAINS -eq 0 ]; then
                echo "Failed request chain"
                exit 1
              fi
              echo $CHAIN_ID > /shared-app-data/PROXY_CREATOR_WALLET_CHAIN_ID
            else
              echo "Chain already exists, skipping init."
            fi
          fi
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
      - name: publish-bytecode
        image: npool/linera-meme:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          POD_INDEX=$(hostname | awk -F '-' '{print $NF}')
          if [ $POD_INDEX -eq 0 ]; then
            if [ -f /shared-app-data/PROXY_MODULE_ID -a -f /shared-app-data/MEME_MODULE_ID ]; then
              MODULE_ID=$(cat /shared-app-data/PROXY_MODULE_ID)
              MEME_MODULE_ID=$(cat /shared-app-data/MEME_MODULE_ID)
            fi
            if [ ! -f /shared-app-data/PROXY_MODULE_ID -o -z "$MODULE_ID" -o ! -f /shared-app-data/MEME_MODULE_ID -o -z "$MEME_MODULE_ID" ]; then
              echo "Publishing bytecode ..."
              MODULE_ID=$(./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db publish-module /bytecodes/proxy_contract.wasm /bytecodes/proxy_service.wasm)
              MEME_MODULE_ID=$(./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db publish-module /bytecodes/meme_contract.wasm /bytecodes/meme_service.wasm)
              if [ -z "$MODULE_ID" -o -z "$MEME_MODULE_ID" ]; then
                echo "Failed publish bytecode"
                exit 1
              fi
              echo $MODULE_ID > /shared-app-data/PROXY_MODULE_ID
              echo $MEME_MODULE_ID > /shared-app-data/MEME_MODULE_ID
            fi
          fi
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
      - name: open-multi-owners-chain
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          POD_INDEX=$(hostname | awk -F '-' '{print $NF}')
          while [ ! -f /shared-app-data/PROXY_CREATOR_WALLET_CHAIN_ID -o -z $CHAIN_ID ]; do
            CHAIN_ID=$(cat /shared-app-data/PROXY_CREATOR_WALLET_CHAIN_ID)
            sleep 10
          done
          while true; do
            count=$(ls /shared-app-data/PROXY_WALLET_OWNER.* -l | wc -l)
            if [ $count -eq ${REPLICAS} ]; then
              break
            fi
            sleep 10
          done

          OWNERS='['
          is_first_owner=1

          for f in /shared-app-data/BLOB_GATEWAY_WALLET_OWNER.*; do
          OWNER=$(tr -d '\n' < "$f")

          if [ "$is_first_owner" -eq 1 ]; then
            is_first_owner=0
          else
            OWNERS="${OWNERS},"
          fi

          OWNERS="${OWNERS}\"${OWNER}\""
          done

          OWNERS="${OWNERS}]"

          if [ -f /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID ]; then
            MULTI_OWNER_CHAIN_ID=$(cat /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID)
          fi
          if [ $POD_INDEX -eq 0 ]; then
            if [ ! -f /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID -o -z $MULTI_OWNER_CHAIN_ID ]; then
              echo "Open multi owners chain..."
              CHAIN_ID=$(./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db open-multi-owner-chain --from $CHAIN_ID --owners $OWNERS --multi-leader-rounds 100 --initial-balance "19.0")
              if [ -z "$CHAIN_ID" ]; then
                echo "Failed open multi owners chain"
                exit 1
              fi
              echo $CHAIN_ID > /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID
            fi
          fi
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
      - name: assign-multi-owners-chain
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          POD_INDEX=$(hostname | awk -F '-' '{print $NF}')
          while [ ! -f /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID -o -z $CHAIN_ID ]; do
            CHAIN_ID=$(cat /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID)
            sleep 10
          done
          CHAIN_ID=$(cat /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID)
          OWNER=$(cat /shared-app-data/PROXY_WALLET_OWNER.$POD_INDEX)
          echo "Assign multi owners chain..."
          ./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db assign --owner $OWNER --chain-id $CHAIN_ID
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
      - name: set-multi-owners-chain-default
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          CHAIN_ID=$(cat /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID)
          echo "Set multi owners chain default..."
          ./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db wallet set-default $CHAIN_ID
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
      - name: process-inbox-1
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          POD_INDEX=$(hostname | awk -F '-' '{print $NF}')
          if [ $POD_INDEX -eq 0 ]; then
            echo "Processing inbox..."
            ./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db process-inbox
          fi
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
      - name: create-application
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          CHAIN_ID=$(cat /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID)
          while [ ! -f /shared-app-data/PROXY_MODULE_ID -o ! -f /shared-app-data/MEME_MODULE_ID -o ! -f /shared-app-data/SWAP_APPLICATION_ID -o -z "$MODULE_ID" -o -z "$MEME_MODULE_ID" ]; do
            MODULE_ID=$(cat /shared-app-data/PROXY_MODULE_ID)
            MEME_MODULE_ID=$(cat /shared-app-data/MEME_MODULE_ID)
            sleep 10
          done
          SWAP_APPLICATION_ID=$(cat /shared-app-data/SWAP_APPLICATION_ID)
          if [ -f /shared-app-data/PROXY_APPLICATION_ID ]; then
            APPLICATION_ID=$(cat /shared-app-data/PROXY_APPLICATION_ID)
          fi
          if [ ! -f /shared-app-data/PROXY_APPLICATION_ID -o -z $APPLICATION_ID ]; then
            echo "Creating application..."
            APPLICATION_ID=$(./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db create-application $MODULE_ID $CHAIN_ID --json-argument "{\"meme_bytecode_id\": \"$MEME_MODULE_ID\", \"operators\": [], \"swap_application_id\": \"$SWAP_APPLICATION_ID\"}")
            if [ -z "$APPLICATION_ID" ]; then
              echo "Failed create application"
              exit 1
            fi
            echo $APPLICATION_ID > /shared-app-data/PROXY_APPLICATION_ID
          fi
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
      - name: process-inbox-2
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          POD_INDEX=$(hostname | awk -F '-' '{print $NF}')
          if [ $POD_INDEX -eq 0 ]; then
            echo "Processing inbox..."
            ./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db process-inbox
           fi
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
      - name: change-multi-owners-chain-single-leader
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          POD_INDEX=$(hostname | awk -F '-' '{print $NF}')
          CHAIN_ID=$(cat /shared-app-data/PROXY_MULTI_OWNER_CHAIN_ID)

          OWNERS='['
          is_first_owner=1

          for f in /shared-app-data/BLOB_GATEWAY_WALLET_OWNER.*; do
          OWNER=$(tr -d '\n' < "$f")

          if [ "$is_first_owner" -eq 1 ]; then
            is_first_owner=0
          else
            OWNERS="${OWNERS},"
          fi

          OWNERS="${OWNERS}\"${OWNER}\""
          done

          OWNERS="${OWNERS}]"

          if [ $POD_INDEX -eq 0 ]; then
            echo "Change multi owners chain to single leader..."
            ./linera --wallet /wallet/wallet.json --keystore /wallet/keystore.json --storage rocksdb:/wallet/client.db change-ownership --chain-id $CHAIN_ID --owners $OWNERS --multi-leader-rounds 0
          fi
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
      containers:
      - name: proxy-service
        image: npool/linera-respeer:latest
        imagePullPolicy: Always
        command: ["/bin/sh", "-c", "./wallet-entrypoint.sh"]
        env:
        - name: RUST_LOG
          value: info
        - name: LINERA_LISTENER_SKIP_PERMISSIONLESS_CHAIN
          value: "true"
        volumeMounts:
        - name: proxy-pvc
          mountPath: /wallet
        - name: shared-app-data
          mountPath: /shared-app-data
        resources:
          requests:
            cpu: "600m"
            memory: "2560Mi"
          limits:
            cpu: "1000m"
            memory: "4096Mi"
      volumes:
      - name: shared-app-data
        persistentVolumeClaim:
          claimName: shared-app-data
  volumeClaimTemplates:
    - metadata:
        name: proxy-pvc
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 20Gi

---
apiVersion: v1
kind: Service
metadata:
  name: proxy-service
  namespace: kube-system
spec:
  ports:
    - name: proxy-service
      port: 8080
      targetPort: 8080
  selector:
    app: proxy-service
